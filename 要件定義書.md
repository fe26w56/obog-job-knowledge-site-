## 要件定義書：学生団体OBOG就活ナレッジサイト（実装状況反映版）

---

### 🎯 **プロジェクト概要**

#### 基本情報
* **目的**：学生団体の現役生とOBOGが就活情報を安全に共有するクローズドプラットフォーム
* **技術スタック**：Next.js 14 + Supabase + Vercel
* **開発状況**：**50%完了**（51/103タスク完了）
* **現在のフェーズ**：月3機能開発（コメント・ブックマーク・通知・管理機能）

---

### 📊 **実装状況サマリー**

#### ✅ **実装完了機能（50%）**
- 🔐 **認証システム**：OTP認証フロー（開発用）
- 👤 **プロフィール機能**：表示・編集・API完備
- 📝 **投稿システム**：CRUD・検索・フィルタ完備
- 💬 **コメント機能**：表示・投稿・承認制
- 📑 **ブックマーク機能**：追加・削除・一覧
- 🔔 **通知システム**：6種類の通知タイプ対応
- 🛠️ **管理ダッシュボード**：統計表示・基本管理
- 🎨 **UIコンポーネント**：全基本コンポーネント

#### 🚧 **実装予定機能（50%）**
- 🔒 **実際の認証**：JWT・OTP送信・Supabase連携
- 👥 **ユーザー管理**：承認・拒否・招待システム
- 📊 **管理機能強化**：投稿管理・統計分析
- 🔗 **連絡先許可システム**：段階的情報開示
- 📧 **メール機能**：通知・承認メール
- 🎨 **UI/UX改善**：PWA・アクセシビリティ

---

### 🗺️ **画面構成・遷移フロー**

#### 🔐 **認証関連画面** ✅ 完了

```
🏠 ホームページ (/)
├── [新規登録] → 📝 登録画面 (/auth/register)
├── [ログイン] → 🔑 ログイン画面 (/auth/login)
└── [認証成功] → 🔢 OTP画面 (/auth/otp)
                 └── [認証完了] → 🏠 ホームページ (/)
```

**実装状況**: ✅ 完了（開発用OTP: 123456）

#### 📝 **投稿関連画面** ✅ 完了

```
📋 投稿一覧 (/posts)
├── [投稿作成] → ✏️ 投稿作成 (/posts/create)
│                └── [保存] → 📄 投稿詳細 (/posts/[id])
├── [投稿カード] → 📄 投稿詳細 (/posts/[id])
│                 ├── 💬 コメント機能
│                 ├── 👍 いいね機能
│                 └── 📑 ブックマーク機能
└── [検索] → 🔍 検索結果 (/search)
```

**実装状況**: ✅ 完了

#### 👤 **プロフィール関連画面** ✅ 完了

```
👤 プロフィール (/profile)
├── [編集] → ✏️ プロフィール編集 (/profile/edit)
│           └── [保存] → 👤 プロフィール (/profile)
└── [設定] → ⚙️ 設定画面 (/settings) 🚧 未実装
```

**実装状況**: ✅ 基本機能完了、設定画面は未実装

#### 📑 **その他機能画面** ✅ 完了

```
📑 ブックマーク (/bookmarks) ✅
├── フィルタ・ソート機能
└── ページネーション

🔔 通知 (/notifications) ✅
├── 未読・全件切り替え
├── 通知タイプ別表示
└── 一括既読機能

🛠️ 管理画面 (/admin) ✅
├── 統計ダッシュボード
├── [ユーザー管理] → 👥 ユーザー管理 (/admin/users) 🚧
├── [投稿管理] → 📝 投稿管理 (/admin/posts) 🚧
└── [統計分析] → 📊 分析画面 (/admin/analytics) 🚧
```

---

### 🔄 **ビジネスロジック詳細**

#### ✅ **実装済みビジネスロジック**

##### 🔐 **認証フロー（開発用）**
1. **メールアドレス入力** → OTP送信（模擬）
2. **OTP認証**（固定値：123456） → 認証成功
3. **セッション管理**（localStorage使用）
4. **ルート保護**（認証必須ページのアクセス制御）

##### 📝 **投稿管理フロー**
1. **投稿作成**: マークダウン形式 → プレビュー → 保存
2. **投稿一覧**: ページネーション・フィルタ・ソート
3. **投稿詳細**: 閲覧数カウント・コメント表示
4. **検索機能**: 全文検索・タグフィルタ・カテゴリフィルタ

##### 💬 **コメントシステム**
1. **コメント投稿**: 承認制（pending → approved）
2. **返信機能**: ネストコメント対応
3. **いいね機能**: コメントへの評価
4. **モデレーション**: 管理者による承認・拒否

##### 📑 **ブックマーク機能**
1. **重複チェック**: 同一投稿の重複ブックマーク防止
2. **フィルタ・ソート**: カテゴリ別・日付順
3. **削除機能**: 個別削除・一括削除

##### 🔔 **通知システム**
1. **通知タイプ**: comment, like, bookmark, follow, system, approval
2. **既読管理**: 個別既読・一括既読
3. **リアルタイム表示**: ヘッダーベル・未読数バッジ

##### 👤 **プロフィール管理**
1. **情報編集**: 基本情報・職歴・連絡先
2. **公開設定**: 連絡先の公開・非公開切り替え
3. **Email統一**: ログイン用 = 連絡先用メールアドレス
4. **ロール管理**: admin, obog, current の権限制御

#### 🚧 **未実装の重要ビジネスロジック**

##### 🔒 **実際の認証システム**
```
1. 実際のOTP送信（GAS/SendGrid）
2. JWT認証・リフレッシュトークン
3. Supabase Auth連携
4. セキュリティ強化（レート制限・ブルートフォース対策）
```

##### 👥 **ユーザー承認フロー**
```
1. 新規ユーザー登録 → 承認待ち状態（pending）
2. 管理者による承認・拒否判定
3. 承認完了通知 → アカウント有効化（active）
4. 拒否時の理由通知・再申請プロセス
```

##### 🔗 **連絡先許可システム**
```
1. 現役生がOBOG連絡先を申請
2. OBOG側で許可・拒否判定
3. 許可時のみ連絡先情報開示
4. 許可取り消し・期限管理
```

##### 📧 **招待制ユーザー登録**
```
1. 管理者が招待URL生成（有効期限・使用回数設定）
2. 招待URL経由でのユーザー登録
3. 招待コード管理・無効化機能
4. 招待履歴・統計管理
```

##### 📊 **投稿承認・モデレーション**
```
1. 投稿の承認制ワークフロー（draft → review → published）
2. 不適切コンテンツの自動検出・手動審査
3. 投稿削除・編集権限管理
4. 違反報告・対応プロセス
```

---

### 🏗️ **データベース設計**

#### ✅ **実装済みテーブル**
- **users**: ユーザー基本情報（型定義完了）
- **profiles**: 詳細プロフィール（API実装済み）
- **posts**: 投稿情報（CRUD完備）
- **comments**: コメント情報（承認制実装済み）
- **bookmarks**: ブックマーク情報（重複チェック付き）
- **notifications**: 通知情報（6種類対応）

#### 🚧 **実装予定テーブル**
- **permissions**: 連絡先閲覧許可管理
- **invitation_urls**: 招待URL管理
- **otp_logs**: OTP送信履歴
- **activity_logs**: ユーザー活動ログ
- **user_approvals**: ユーザー承認履歴

---

### 🔌 **API設計**

#### ✅ **実装済みAPI**

##### 認証系（開発用）
- `POST /api/auth/login` - ログイン（モック）
- `POST /api/auth/register` - ユーザー登録（モック）
- `POST /api/auth/verify-otp` - OTP認証（モック）

##### ユーザー管理
- `GET /api/users/profile` - プロフィール取得
- `PUT /api/users/profile` - プロフィール更新

##### 投稿管理
- `GET /api/posts` - 投稿一覧（ページネーション・フィルタ対応）
- `POST /api/posts` - 投稿作成
- `GET /api/posts/[id]` - 投稿詳細
- `PUT /api/posts/[id]` - 投稿更新
- `DELETE /api/posts/[id]` - 投稿削除
- `GET /api/posts/search` - 投稿検索
- `POST /api/posts/[id]/like` - いいね機能

##### その他機能
- `GET/POST/DELETE /api/bookmarks` - ブックマーク管理
- `GET/POST/PUT /api/notifications` - 通知管理
- `GET/POST /api/comments` - コメント管理

#### 🚧 **実装予定API**

##### 認証系（本格実装）
- `POST /api/auth/send-otp` - OTP送信
- `POST /api/auth/refresh` - トークンリフレッシュ
- `POST /api/auth/logout` - ログアウト

##### 管理機能
- `GET /api/admin/users` - ユーザー一覧
- `PUT /api/admin/users/[id]/approve` - ユーザー承認
- `POST /api/admin/invitations` - 招待URL生成
- `GET /api/admin/analytics` - 統計データ

##### ファイル管理
- `POST /api/upload` - ファイルアップロード
- `DELETE /api/upload/[id]` - ファイル削除

---

### 🎯 **権限・ロール管理**

#### ✅ **実装済み権限システム**

| 機能 | 管理者 | OBOG | 現役生 | 未承認 | 実装状況 |
|------|-------|------|--------|--------|----------|
| ログイン | ✅ | ✅ | ✅ | ✅ | ✅ 完了 |
| プロフィール編集 | ✅ | ✅ | ✅ | ❌ | ✅ 完了 |
| 投稿作成 | ✅ | ✅ | ❌ | ❌ | ✅ 完了 |
| 投稿閲覧 | ✅ | ✅ | ✅ | ❌ | ✅ 完了 |
| コメント投稿 | ✅ | ✅ | ✅ | ❌ | ✅ 完了 |
| ブックマーク | ✅ | ✅ | ✅ | ❌ | ✅ 完了 |
| 通知受信 | ✅ | ✅ | ✅ | ❌ | ✅ 完了 |
| 管理画面アクセス | ✅ | ❌ | ❌ | ❌ | ✅ 完了 |

#### 🚧 **実装予定権限システム**

| 機能 | 管理者 | OBOG | 現役生 | 未承認 | 実装予定 |
|------|-------|------|--------|--------|----------|
| ユーザー承認 | ✅ | ❌ | ❌ | ❌ | 🚧 月4 |
| 投稿承認 | ✅ | ❌ | ❌ | ❌ | 🚧 月4 |
| 連絡先閲覧 | ✅ | 🔒許可制 | 🔒許可制 | ❌ | 🚧 月4 |
| 招待URL生成 | ✅ | ❌ | ❌ | ❌ | 🚧 月4 |
| 統計閲覧 | ✅ | ❌ | ❌ | ❌ | 🚧 月4 |

---

### 📋 **今後の開発計画**

#### 🎯 **月3残りタスク（現在進行中）**
- [ ] **#054**: ユーザー管理機能（承認・拒否・ロール変更）
- [ ] **#055**: 投稿管理・モデレーション機能
- [ ] **#056**: 招待URL生成機能
- [ ] **#057**: 統計・分析機能

#### 🔄 **月4実装予定（UI/UX改善・統合）**
- [ ] **実際の認証システム**: JWT・OTP送信・Supabase連携
- [ ] **連絡先許可システム**: 段階的情報開示
- [ ] **メール機能**: 通知・承認メール送信
- [ ] **リアルタイム機能**: WebSocket通知
- [ ] **PWA対応**: オフライン機能・プッシュ通知

#### 🧪 **月5-6予定（テスト・リリース）**
- [ ] **テスト実装**: 単体・統合・E2Eテスト
- [ ] **セキュリティ強化**: 脆弱性対策・監査
- [ ] **パフォーマンス最適化**: Core Web Vitals改善
- [ ] **本番デプロイ**: CI/CD・監視設定

---

### 🚨 **重要な抜け漏れチェック**

#### ❌ **未実装の重要画面遷移**
1. **ユーザー承認フロー**: `/admin/users/pending` → 承認・拒否操作
2. **連絡先申請フロー**: `/profile/[id]/contact` → 許可申請・承認
3. **招待管理フロー**: `/admin/invitations` → URL生成・管理
4. **投稿承認フロー**: `/admin/posts/pending` → 承認・拒否操作

#### ❌ **未実装の重要ビジネスロジック**
1. **段階的権限付与**: 未承認 → 承認待ち → 有効化
2. **連絡先段階開示**: 基本情報 → 許可申請 → 連絡先開示
3. **投稿承認ワークフロー**: 下書き → 審査 → 公開
4. **違反報告・対応**: 報告受付 → 審査 → 対応措置

#### ❌ **未実装のセキュリティ要件**
1. **レート制限**: API呼び出し・ログイン試行制限
2. **入力値検証**: XSS・SQLインジェクション対策
3. **ファイルアップロード制限**: サイズ・形式・ウイルススキャン
4. **監査ログ**: 重要操作の記録・保持

---

### 🎉 **最終目標**

**学生団体のOBOGと現役生が安全・効率的に就活情報を共有できる、高品質でスケーラブルなプラットフォームの完成**

- **機能完成度**: 100%（103/103タスク完了）
- **ユーザー満足度**: 4.0/5.0以上
- **システム稼働率**: 99.5%以上
- **セキュリティレベル**: 企業レベルの安全性確保
- **パフォーマンス**: Core Web Vitals全項目Good達成

---

## 📊 **進捗サマリー**

**現在の進捗**: 51/103タスク完了 (50%) 🎉 **50%マイルストーン達成！**

### ✅ **完了済み**
- フェーズ1（設計・準備）: 100%完了
- 月1（基盤・認証）: 100%完了  
- 月2（投稿・検索）: 100%完了
- 月3（コメント・ブックマーク・通知・管理）: 80%完了

### 🎯 **次のマイルストーン**
- 月3完了: 60%達成予定
- 月4完了: 80%達成予定
- 最終完成: 100%達成予定

この要件定義書に基づいて、残り50%の実装を確実に進めて完成度の高いプラットフォームを構築していきます！🚀

